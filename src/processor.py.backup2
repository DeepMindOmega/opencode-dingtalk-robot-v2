#!/usr/bin/env python3
import json
import subprocess
import os
import sys
import time
from datetime import datetime
from pathlib import Path

sys.path.insert(0, "/home/admin/.opencode/skills/dingtalk-robot/src")
from queue_manager import QueueManager
from session_manager import SessionManager

CONFIG_DIR = "/home/admin/.opencode/skills/dingtalk-robot"
CONFIG_PATH = os.path.join(CONFIG_DIR, "config.local.json")
if not os.path.exists(CONFIG_PATH):
    CONFIG_PATH = os.path.join(CONFIG_DIR, "config.json")
with open(CONFIG_PATH, "r") as f:
    CONFIG = json.load(f)

qm = QueueManager(CONFIG["QUEUE_DIR"])
sm = SessionManager(os.path.join(CONFIG_DIR, "sessions.json"))
OPENCODE_BIN = "/home/admin/.npm-global/bin/opencode"

print(f"é…ç½®æ–‡ä»¶: {CONFIG_PATH}")
print(f"OpenCodeè·¯å¾„: {OPENCODE_BIN}")


def run_opencode(message, continue_session=False, images=None, timeout=120):
    opencode_dir = "/home/admin/.local/share/opencode"
    screenshots_before = set()

    if os.path.exists(opencode_dir):
        for root, dirs, files in os.walk(opencode_dir):
            for file in files:
                if file.lower().endswith((".png", ".jpg", ".jpeg", ".gif")):
                    screenshots_before.add(os.path.join(root, file))

    try:
        cmd = [OPENCODE_BIN, "run", message, "--format", "json"]
        if continue_session:
            cmd.append("--continue")
        if images:
            for img_path in images:
                if os.path.exists(img_path):
                    cmd.extend(["--file", img_path])
                    print(f"    â†’ é™„åŠ æ–‡ä»¶: {img_path}")
        result = subprocess.run(
            cmd, capture_output=True, text=True, timeout=timeout, cwd="/home/admin"
        )
        output = result.stdout if result.stdout else ""
        error = result.stderr if result.stderr else ""

        screenshots_after = set()
        if os.path.exists(opencode_dir):
            for root, dirs, files in os.walk(opencode_dir):
                for file in files:
                    if file.lower().endswith((".png", ".jpg", ".jpeg", ".gif")):
                        screenshots_after.add(os.path.join(root, file))

        generated_images = list(screenshots_after - screenshots_before)

        if not output and not generated_images:
            return "OpenCode æ‰§è¡Œå®Œæˆï¼ˆæ— è¾“å‡ºï¼‰", None, generated_images

        lines = output.strip().split("\n")
        response_text = []
        extracted_session_id = None

        for line in lines:
            try:
                data = json.loads(line)
                if data.get("type") == "text":
                    response_text.append(data.get("part", {}).get("text", ""))
                if "sessionID" in data:
                    extracted_session_id = data["sessionID"]
            except:
                pass

        response = "\n".join(response_text) if response_text else "æ— è¾“å‡º"
        return response, extracted_session_id, generated_images
    except subprocess.TimeoutExpired:
        return "å‘½ä»¤è¶…æ—¶ (" + str(timeout) + "s)", None, []
    except FileNotFoundError:
        return "é”™è¯¯: æ‰¾ä¸åˆ° OpenCode: " + OPENCODE_BIN, None, []
    except Exception as e:
        return "æ‰§è¡Œå¼‚å¸¸: " + str(e), None, []


def execute_shell(cmd, timeout=30, cwd="/home/admin"):
    try:
        result = subprocess.run(
            cmd, shell=True, capture_output=True, text=True, timeout=timeout, cwd=cwd
        )
        output = result.stdout + result.stderr
        return output[:2000] if output else "(æ— è¾“å‡º)"
    except subprocess.TimeoutExpired:
        return "å‘½ä»¤è¶…æ—¶ (" + str(timeout) + "s)"
    except Exception as e:
        return "æ‰§è¡Œé”™è¯¯: " + str(e)


def process_task(task):
    msg = task.get("message", "").strip()
    user_id = task.get("user_id", "")
    user_nick = task.get("user_nick", "ç”¨æˆ·")
    conv_id = task.get("conv_id", "")
    conv_type = task.get("conv_type", "1")
    images = task.get("images", [])
    msg_lower = msg.lower()
    parts = msg.split()
    first_word = parts[0] if parts else ""

    if msg in ["æ–°å¯¹è¯", "new", "reset"]:
        new_session = sm.create_new_session(user_id, conv_id, conv_type)
        return "âœ… å·²åˆ›å»ºæ–°å¯¹è¯ï¼Œä¹‹å‰çš„ä¸Šä¸‹æ–‡å·²æ¸…é™¤", []

    if first_word in ["ç§èŠ", "å‘ç§ä¿¡", "å‘ç§èŠ", "dm"] and len(parts) > 1:
        target_user = parts[1].strip("@")
        target_msg = " ".join(parts[2:]) if len(parts) > 2 else "ä½ å¥½"

        if target_user:
            return f"[ç§èŠ:{target_user}] {target_msg}", []
        else:
            return "âŒ è¯·æŒ‡å®šè¦å‘é€ç§èŠçš„ç”¨æˆ·ï¼Œä¾‹å¦‚ï¼šç§èŠ @ç”¨æˆ·ID ä½ å¥½", []

    if (
        any(k in msg for k in ["åˆ—å‡º", "æ–‡ä»¶åˆ—è¡¨", "ç›®å½•"])
        and "æ–‡ä»¶" not in msg
        or msg_lower == "ls"
    ):
        return "ğŸ“ ç›®å½•æ–‡ä»¶:\n```\n" + execute_shell("ls -la") + "\n```", []

    if first_word in ["æŸ¥çœ‹", "è¯»å–", "cat"] and len(parts) > 1:
        filename = parts[-1].strip("'\"")
        filepath = "/home/admin/" + filename
        if os.path.exists(filepath):
            with open(filepath, "r", encoding="utf-8") as f:
                content = f.read(2000)
            return "ğŸ“„ " + filename + ":\n\n" + content, []
        return "âŒ æ–‡ä»¶ä¸å­˜åœ¨: " + filename, []

    if first_word in ["æ‰§è¡Œ", "è¿è¡Œ"] and len(parts) > 1:
        cmd = " ".join(parts[1:])
        return "ğŸ”§ " + cmd + "\n```\n" + execute_shell(cmd) + "\n```", []

    if msg in ["çŠ¶æ€", "status", "/status"]:
        return "ğŸ“Š ç³»ç»ŸçŠ¶æ€\nâ° " + str(datetime.now()) + "\nğŸ“‚ /home/admin", []

    if msg in ["å¸®åŠ©", "help", "/help"]:
        return (
            """ğŸ¤– OpenCode åŠ©æ‰‹

ğŸ“ å¯ç”¨æŒ‡ä»¤:
â€¢ ç›´æ¥å‘é€ä»»æ„æŒ‡ä»¤ - OpenCode ä¼šæ‰§è¡Œå¹¶å›å¤ï¼ˆå¸¦ä¸Šä¸‹æ–‡è®°å¿†ï¼‰
â€¢ æ–°å¯¹è¯ - æ¸…é™¤ä¸Šä¸‹æ–‡ï¼Œå¼€å¯æ–°å¯¹è¯
â€¢ åˆ—å‡ºç›®å½• - æŸ¥çœ‹æ–‡ä»¶
â€¢ æŸ¥çœ‹ <æ–‡ä»¶> - è¯»å–æ–‡ä»¶
â€¢ æ‰§è¡Œ <å‘½ä»¤> - è¿è¡Œå‘½ä»¤
â€¢ çŠ¶æ€ - ç³»ç»Ÿä¿¡æ¯
â€¢ å¸®åŠ© - æ˜¾ç¤ºå¸®åŠ©

ğŸ’¬ æ¯ä¸ªå¯¹è¯ä¼šè‡ªåŠ¨è®°å¿†ä¸Šä¸‹æ–‡ï¼
ğŸ“· æ”¯æŒå‘é€å’Œæ¥æ”¶å›¾ç‰‡ï¼""",
            [],
        )

    # ç§èŠæ€»æ˜¯å¼€å§‹æ–°ä¼šè¯ï¼Œé¿å…å…±äº«ä¼šè¯å¯¼è‡´çš„"æ— è¾“å‡º"é—®é¢˜
    # ç¾¤èŠä½¿ç”¨ --continue ä¿æŒä¸Šä¸‹æ–‡è®°å¿†
    continue_session = (conv_type == "2") and sm.should_continue_session(
        user_id, conv_id, conv_type
    )

    opencode_msg = msg

    valid_images = None
    if images:
        print(f"  â†’ é™„åŠ  {len(images)} å¼ å›¾ç‰‡")
        valid_images = [img for img in images if os.path.exists(img)]
        if valid_images:
            opencode_msg = msg
            for img_path in valid_images:
                opencode_msg += f"\n[å·²é™„åŠ å›¾ç‰‡: {img_path}]"
        else:
            opencode_msg = msg + "\n[æ— æ³•è¯»å–å›¾ç‰‡æ–‡ä»¶]"

    print("  â†’ è½¬å‘ç»™ OpenCode: " + opencode_msg[:50] + "...")
    print("  â†’ ç»§ç»­ä¼šè¯: " + ("æ˜¯" if continue_session else "å¦"))
    response, new_session_id, generated_images = run_opencode(
        opencode_msg,
        continue_session=continue_session,
        images=valid_images if valid_images else None,
    )

    if new_session_id:
        print("  â†’ æ–°ä¼šè¯ ID: " + new_session_id)
        sm.update_session_id(user_id, conv_id, conv_type, new_session_id)

    if generated_images:
        print(f"  â†’ ç”Ÿæˆå›¾ç‰‡: {len(generated_images)} å¼ ")
        for img in generated_images:
            print(f"      - {img}")

    if len(response) > 5000:
        response = response[:5000] + "\n\n...(è¾“å‡ºè¿‡é•¿ï¼Œå·²æˆªæ–­)"

    return response, generated_images


def main():
    print("[" + str(datetime.now()) + "] é’‰é’‰ä»»åŠ¡å¤„ç†å™¨å¯åŠ¨ (OpenCode é›†æˆç‰ˆ)")
    print("é˜Ÿåˆ—ç›®å½•: " + CONFIG["QUEUE_DIR"])
    print("OpenCode è·¯å¾„: " + OPENCODE_BIN)
    processed = set()

    while True:
        try:
            tasks = qm.get_pending_tasks()
            for tid, task in tasks.items():
                if tid in processed:
                    continue

                print("\n[" + datetime.now().strftime("%H:%M:%S") + "] å¤„ç†: " + tid)
                print("  ç”¨æˆ·: " + task.get("user_nick"))
                print("  æ¶ˆæ¯: " + task.get("message"))

                response, images = process_task(task)
                print("  å›å¤é•¿åº¦: " + str(len(response)) + " å­—ç¬¦")

                qm.complete_task(tid, response)
                qm.add_result(
                    tid,
                    task["user_id"],
                    response,
                    task.get("conv_id", ""),
                    task.get("conv_type", "1"),
                    images,
                )
                processed.add(tid)
                print("  âœ“ å®Œæˆ")
        except Exception as e:
            print("é”™è¯¯: " + str(e))
            import traceback

            traceback.print_exc()

        time.sleep(2)


if __name__ == "__main__":
    main()
